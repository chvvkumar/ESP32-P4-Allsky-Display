name: File Structure Validation

on:
  pull_request:
    branches: [ main, Snd, Dev ]
  workflow_dispatch:

jobs:
  structure:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check required files exist
      run: |
        required_files=(
          "README.md"
          ".gitignore"
          "ESP32-P4-Allsky-Display.ino"
          "config.h"
          "config.cpp"
          "config_storage.h"
          "config_storage.cpp"
        )
        
        missing=0
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing required file: $file"
            missing=1
          fi
        done
        
        if [ $missing -eq 1 ]; then
          exit 1
        fi
        echo "✅ All required files present"
    
    - name: Check for header/source pairs
      run: |
        for header in *.h; do
          base="${header%.h}"
          if [ "$base" != "web_config_html" ] && [ "$base" != "displays_config" ] && [ ! -f "${base}.cpp" ]; then
            echo "⚠️ Header $header has no matching .cpp file"
          fi
        done
        echo "✅ Header/source check complete"
    
    - name: Validate file naming convention
      run: |
        invalid_count=0
        for file in *.cpp *.h *.ino; do
          if [ -f "$file" ]; then
            basename=$(basename "$file")
            if ! echo "$basename" | grep -qE "^[a-zA-Z0-9_-]+\.(cpp|h|ino)$"; then
              echo "⚠️ File not following naming convention: $basename"
              invalid_count=$((invalid_count + 1))
            fi
          fi
        done
        
        if [ $invalid_count -eq 0 ]; then
          echo "✅ All files follow naming convention"
        else
          echo "⚠️ Found $invalid_count files with non-standard naming"
        fi
