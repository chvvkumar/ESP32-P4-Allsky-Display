name: Memory Usage Analysis

on:
  push:
    branches: [ main, Snd, Dev ]
  pull_request:
    branches: [ main, Snd, Dev ]
  workflow_dispatch:

jobs:
  memory:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
    
    - name: Cache Arduino CLI dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.arduino15
          ~/Arduino/libraries
        key: ${{ runner.os }}-arduino-${{ hashFiles('**/ESP32-P4-Allsky-Display.ino') }}
        restore-keys: |
          ${{ runner.os }}-arduino-
    
    - name: Install ESP32 core and libraries
      run: |
        arduino-cli core update-index --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        arduino-cli core install esp32:esp32@3.3.4 --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        arduino-cli lib install "GFX Library for Arduino"
        arduino-cli lib install "JPEGDEC"
        arduino-cli lib install "PubSubClient"
    
    - name: Patch GFX Library for ESP32-P4 compatibility
      run: |
        # Fix MIPI_DSI_PHY_CLK_SRC_DEFAULT compatibility issue
        sed -i 's/.phy_clk_src = MIPI_DSI_PHY_CLK_SRC_DEFAULT,/.phy_clk_src = MIPI_DSI_PHY_PLLREF_CLK_SRC_PLL_F20M, \/\/MIPI_DSI_PHY_CLK_SRC_DEFAULT,/' ~/Arduino/libraries/GFX_Library_for_Arduino/src/databus/Arduino_ESP32DSIPanel.cpp
        echo "✅ GFX Library patched for ESP32-P4"
    
    - name: Compile and analyze memory
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32p4 \
          --build-property "build.flash_size=32MB" \
          --build-property "build.psram_type=opi" \
          --build-property "build.partitions=huge_app" \
          --build-property "compiler.cpp.extra_flags=-DBOARD_HAS_PSRAM" \
          ESP32-P4-Allsky-Display.ino > build.log 2>&1 || true
        
        # Show compilation errors if any
        if grep -q "Error" build.log; then
          echo "⚠️ Compilation errors found:"
          grep -A 5 "Error" build.log || true
        fi
        
        # Extract memory usage
        if grep -q "Sketch uses" build.log; then
          grep "Sketch uses" build.log || true
          grep "Global variables" build.log || true
          echo "✅ Memory analysis complete"
        else
          echo "⚠️ Could not extract memory usage details"
          echo "Last 50 lines of build log:"
          tail -50 build.log
        fi
    
    - name: Parse memory usage
      id: memory
      run: |
        # Extract flash usage
        FLASH_LINE=$(grep "Sketch uses" build.log || echo "")
        if [ -n "$FLASH_LINE" ]; then
          FLASH_USED=$(echo "$FLASH_LINE" | grep -oP '\d+' | head -1)
          FLASH_MAX=$(echo "$FLASH_LINE" | grep -oP '\d+' | tail -1)
          FLASH_PCT=$(echo "$FLASH_LINE" | grep -oP '\d+%' | sed 's/%//')
          echo "flash_used=$FLASH_USED" >> $GITHUB_OUTPUT
          echo "flash_max=$FLASH_MAX" >> $GITHUB_OUTPUT
          echo "flash_pct=$FLASH_PCT" >> $GITHUB_OUTPUT
        fi
        
        # Extract RAM usage
        RAM_LINE=$(grep "Global variables" build.log || echo "")
        if [ -n "$RAM_LINE" ]; then
          RAM_USED=$(echo "$RAM_LINE" | grep -oP '\d+' | head -1)
          RAM_MAX=$(echo "$RAM_LINE" | grep -oP '\d+' | tail -1)
          RAM_PCT=$(echo "$RAM_LINE" | grep -oP '\d+%' | sed 's/%//')
          echo "ram_used=$RAM_USED" >> $GITHUB_OUTPUT
          echo "ram_max=$RAM_MAX" >> $GITHUB_OUTPUT
          echo "ram_pct=$RAM_PCT" >> $GITHUB_OUTPUT
        fi
    
    - name: Create memory badges
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/Snd'
      run: |
        mkdir -p .github/badges
        
        # Determine flash color
        FLASH_PCT=${{ steps.memory.outputs.flash_pct }}
        if [ "$FLASH_PCT" -ge 95 ]; then
          FLASH_COLOR="red"
        elif [ "$FLASH_PCT" -ge 80 ]; then
          FLASH_COLOR="orange"
        else
          FLASH_COLOR="green"
        fi
        
        # Determine RAM color
        RAM_PCT=${{ steps.memory.outputs.ram_pct }}
        if [ "$RAM_PCT" -ge 80 ]; then
          RAM_COLOR="orange"
        elif [ "$RAM_PCT" -ge 60 ]; then
          RAM_COLOR="yellow"
        else
          RAM_COLOR="green"
        fi
        
        # Create JSON files for shields.io endpoint badges
        echo "{\"schemaVersion\":1,\"label\":\"Flash\",\"message\":\"$FLASH_PCT% (${{ steps.memory.outputs.flash_used }} / ${{ steps.memory.outputs.flash_max }} bytes)\",\"color\":\"$FLASH_COLOR\"}" > .github/badges/flash.json
        echo "{\"schemaVersion\":1,\"label\":\"RAM\",\"message\":\"$RAM_PCT% (${{ steps.memory.outputs.ram_used }} / ${{ steps.memory.outputs.ram_max }} bytes)\",\"color\":\"$RAM_COLOR\"}" > .github/badges/ram.json
    
    - name: Commit badges
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/Snd'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .github/badges/*.json || true
        git diff --staged --quiet || git commit -m "Update memory usage badges [skip ci]"
        git push || true
    
    - name: Check for memory warnings
      run: |
        if grep -i "warning.*memory\|overflow" build.log; then
          echo "⚠️ Memory warnings detected"
          exit 1
        fi
        echo "✅ No memory warnings"
