name: Memory Usage Analysis

on:
  push:
    branches: [ main, Snd, Dev ]
  pull_request:
    branches: [ main, Snd, Dev ]

jobs:
  memory:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
    
    - name: Install ESP32 core and libraries
      run: |
        arduino-cli core update-index --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        arduino-cli core install esp32:esp32@3.3.4 --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        arduino-cli lib install "GFX Library for Arduino"
        arduino-cli lib install "JPEGDEC"
        arduino-cli lib install "PubSubClient"
    
    - name: Compile and analyze memory
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32p4 \
          --build-property "build.flash_size=32MB" \
          --build-property "build.psram_type=opi" \
          --build-property "build.partitions=huge_app" \
          --build-property "compiler.cpp.extra_flags=-DBOARD_HAS_PSRAM" \
          ESP32-P4-Allsky-Display.ino --verbose > build.log 2>&1 || true
        
        # Show compilation errors if any
        if grep -q "Error" build.log; then
          echo "⚠️ Compilation errors found:"
          grep -A 5 "Error" build.log || true
        fi
        
        # Extract memory usage
        if grep -q "Sketch uses" build.log; then
          grep "Sketch uses" build.log || true
          grep "Global variables" build.log || true
          echo "✅ Memory analysis complete"
        else
          echo "⚠️ Could not extract memory usage details"
          echo "Last 50 lines of build log:"
          tail -50 build.log
        fi
    
    - name: Check for memory warnings
      run: |
        if grep -i "warning.*memory\|overflow" build.log; then
          echo "⚠️ Memory warnings detected"
          exit 1
        fi
        echo "✅ No memory warnings"
